<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' https://thirdweb.com https://cdn.thirdweb.com https://cdnjs.cloudflare.com;
    script-src 'self' 'unsafe-eval' 'unsafe-inline' https://thirdweb.com https://cdn.thirdweb.com https://cdnjs.cloudflare.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://mojoclaim.pages.dev;
    img-src 'self' data: https://mojoclaim.pages.dev https://bafybeig6dpytw3q4v7vzdy6sb7q4x3apqgrvfi3zsbvb3n6wvs5unfr36i.ipfs.dweb.link;
    font-src 'self' https://fonts.gstatic.com;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mojo Claim Page</title>
    <link rel="stylesheet" href="frontend/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/thirdweb/3.2.2/thirdweb.umd.min.js"></script> 
</head>
<body>
    <div class="background">
        <div class="content">
            <img src="https://bafybeig6dpytw3q4v7vzdy6sb7q4x3apqgrvfi3zsbvb3n6wvs5unfr36i.ipfs.dweb.link?filename=480.gif" 
                 alt="Mojo Token Logo" class="logo">
            <h1 class="animated-text">Awesome Artists-Sweet Fans-Fueled by Mojo</h1>
            <div id="wallet-connect">
                <button id="connect-btn">Connect Wallet</button>
                <button id="claim-btn" style="display: none;">Claim Mojo</button>
                <div id="status">Initializing...</div>
            </div>
        </div>
    </div>

    <script>
        // ✅ Fix: Properly load Thirdweb SDK
        const sdk = new thirdweb.ThirdwebSDK("optimism", {
            clientId: "692b03efca5fa1f10f792dcf20fa172c",
        });

        const status = document.getElementById("status");
        status.textContent = "SDK Loaded.";

        const connectBtn = document.getElementById("connect-btn");
        const claimBtn = document.getElementById("claim-btn");

        connectBtn.addEventListener("click", async () => {
            try {
                if (!window.ethereum) {
                    status.textContent = "MetaMask not detected! Please install MetaMask.";
                    return;
                }

                status.textContent = "Connecting to MetaMask...";
                await sdk.wallet.connect("metamask");
                const wallet = (await sdk.wallet.getAddress()).toLowerCase();
                status.textContent = `Connected: ${wallet}`;
                connectBtn.style.display = "none";
                claimBtn.style.display = "block";
            } catch (error) {
                console.error("Connect failed:", error);
                status.textContent = "Failed: " + error.message;
            }
        });

        claimBtn.addEventListener("click", async () => {
            try {
                const wallet = (await sdk.wallet.getAddress()).toLowerCase();
                status.textContent = "Claiming 100,000 Mojo...";
                
                // ✅ Fix: Ensure CORS headers allow requests
                const response = await fetch("https://mojo-claim-worker.fletcher-christians-account3359.workers.dev", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Access-Control-Allow-Origin": "*"
                    },
                    body: JSON.stringify({ wallet }),
                });

                const result = await response.json();
                if (result.status === "success") {
                    status.textContent = `Claimed! Tx Hash: ${result.transactionHash}`;
                } else {
                    status.textContent = `Error: ${result.message}`;
                }
            } catch (error) {
                console.error("Claim failed:", error);
                status.textContent = "Failed: " + error.message;
            }
        });
    </script>
</body>
</html>